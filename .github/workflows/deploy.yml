name: Deploy Fashion Shop Admin

on:
  push:
    branches: [ master, main ]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout Code
      uses: actions/checkout@v3
    
    - name: Install pnpm
      uses: pnpm/action-setup@v2
    
    - name: Setup Node.js
      uses: actions/setup-node@v3
      with:
        node-version: '20'
        cache: 'pnpm'
    
    - name: Install Dependencies
      run: pnpm install --frozen-lockfile
    
    - name: Build Project
      run: pnpm run build
    
    - name: Package Build Files
      run: |
        echo "æ‰“åŒ…æ„å»ºæ–‡ä»¶..."
        cd dist
        tar -czf ../dist.tar.gz .
        cd ..
        echo "æ‰“åŒ…å®Œæˆï¼"
        ls -lh dist.tar.gz
    
    - name: Deploy via SSH
      uses: appleboy/ssh-action@v0.1.10
      with:
        host: ${{ secrets.SERVER_HOST }}
        username: ${{ secrets.SERVER_USER }}
        key: ${{ secrets.SERVER_SSH_KEY }}
        script: |
          # å‡†å¤‡ä¸´æ—¶ç›®å½•
          mkdir -p /tmp/fashion-deploy
          
    - name: Upload Package
      run: |
        echo "ä¸Šä¼ æ–‡ä»¶åˆ°æœåŠ¡å™¨..."
        scp -o StrictHostKeyChecking=no -i <(echo "${{ secrets.SERVER_SSH_KEY }}") dist.tar.gz ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }}:/tmp/fashion-deploy/
    
    - name: Extract and Deploy
      uses: appleboy/ssh-action@v0.1.10
      with:
        host: ${{ secrets.SERVER_HOST }}
        username: ${{ secrets.SERVER_USER }}
        key: ${{ secrets.SERVER_SSH_KEY }}
        script: |
          set -e
          
          echo "=========================================="
          echo "å¼€å§‹éƒ¨ç½²: $(date)"
          echo "=========================================="
          
          # å¤‡ä»½
          if [ -d "${{ secrets.SERVER_PATH }}" ] && [ "$(ls -A ${{ secrets.SERVER_PATH }})" ]; then
            BACKUP_DIR="${{ secrets.SERVER_PATH }}.backup.$(date +%Y%m%d_%H%M%S)"
            echo "å¤‡ä»½åˆ°: $BACKUP_DIR"
            sudo cp -r ${{ secrets.SERVER_PATH }} $BACKUP_DIR
          fi
          
          # æ¸…ç©ºå¹¶è§£å‹
          echo "æ¸…ç©ºç›®æ ‡ç›®å½•..."
          sudo rm -rf ${{ secrets.SERVER_PATH }}/*
          
          echo "è§£å‹æ–‡ä»¶..."
          sudo tar -xzf /tmp/fashion-deploy/dist.tar.gz -C ${{ secrets.SERVER_PATH }}/
          
          # æƒé™
          echo "è®¾ç½®æƒé™..."
          sudo chown -R www-data:www-data ${{ secrets.SERVER_PATH }} 2>/dev/null || sudo chown -R nginx:nginx ${{ secrets.SERVER_PATH }}
          sudo chmod -R 755 ${{ secrets.SERVER_PATH }}
          
          # éªŒè¯
          echo "=========================================="
          echo "éƒ¨ç½²æ–‡ä»¶åˆ—è¡¨:"
          ls -lah ${{ secrets.SERVER_PATH }} | head -n 15
          
          echo "=========================================="
          echo "index.html å†…å®¹:"
          head -n 3 ${{ secrets.SERVER_PATH }}/index.html
          
          # Nginx
          echo "=========================================="
          echo "å¤„ç† Nginx..."
          
          # æµ‹è¯•é…ç½®
          sudo nginx -t
          
          # å¯åŠ¨æˆ–é‡è½½
          if pgrep nginx > /dev/null; then
            echo "é‡æ–°åŠ è½½ Nginx..."
            sudo systemctl reload nginx || sudo nginx -s reload
          else
            echo "å¯åŠ¨ Nginx..."
            sudo systemctl start nginx || sudo /usr/sbin/nginx
          fi
          
          # ç­‰å¾…å¹¶æ£€æŸ¥
          sleep 3
          
          if pgrep nginx > /dev/null; then
            echo "âœ… Nginx è¿è¡Œæ­£å¸¸"
            echo "è¿›ç¨‹ä¿¡æ¯:"
            ps aux | grep nginx | grep -v grep | head -n 3
          else
            echo "âŒ Nginx æœªè¿è¡Œ"
            exit 1
          fi
          
          # æ¸…ç†
          echo "=========================================="
          echo "æ¸…ç†ä¸´æ—¶æ–‡ä»¶..."
          rm -rf /tmp/fashion-deploy
          
          echo "=========================================="
          echo "âœ… éƒ¨ç½²å®Œæˆï¼"
          echo "æ—¶é—´: $(date)"
          echo "è®¿é—®: http://www.yyzzhhh.work.gd"
          echo "=========================================="
    
    - name: Test Deployment
      run: |
        echo "æµ‹è¯•ç½‘ç«™è®¿é—®..."
        sleep 5
        curl -I http://${{ secrets.SERVER_HOST }} || echo "ç½‘ç«™å¯èƒ½è¿˜åœ¨å¯åŠ¨ä¸­..."
    
    - name: Deployment Result
      if: always()
      run: |
        if [ ${{ job.status }} == 'success' ]; then
          echo "ğŸ‰ éƒ¨ç½²æˆåŠŸï¼"
          echo "è®¿é—®: http://www.yyzzhhh.work.gd"
        else
          echo "âŒ éƒ¨ç½²å¤±è´¥ï¼Œè¯·æ£€æŸ¥æ—¥å¿—"
        fi
